<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè´ Class Locator - SmartUms</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(rgba(2,4,15,0.7), rgba(114, 116, 138, 0.7)),
                url('https://backendstudypal.studypal.my/storage/schoolMedia/UMS%20-%20Universiti%20Malaysia%20Sabah_cover.jpeg');
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .search-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            align-self: flex-end;
            transition: all 0.3s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-buttons {
            text-align: center;
            margin-bottom: 20px;
        }

        .nav-btn {
            display: inline-block;
            padding: 12px 25px;
            margin: 0 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 16px;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tag {
            background: #f0f0f0;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tag:hover {
            background: #667eea;
            color: white;
        }

        .tag.active {
            background: #667eea;
            color: white;
        }

        .results-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .class-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s;
            border-left: 5px solid #667eea;
            cursor: pointer;
        }

        .class-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .class-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .class-info {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.95em;
            color: #555;
        }

        .info-label {
            font-weight: 600;
            color: #333;
            min-width: 80px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 12px;
        }

        .status-available, .status-open {
            background: #d4edda;
            color: #155724;
        }

        .status-full, .status-closed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-upcoming {
            background: #d1ecf1;
            color: #0c5460;
        }

        .map-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .map-header {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-info {
            font-size: 0.8em;
            color: #666;
            font-weight: normal;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
            font-size: 1.2em;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes floatIn { 
            from { transform: translateY(12px); opacity: 0; } 
            to { transform: none; opacity: 1; } 
        }

        .container, .map-container, .search-section { 
            animation: floatIn 420ms ease both; 
            transition: box-shadow 220ms ease, transform 220ms ease; 
        }

        .class-card { 
            transition: transform 260ms ease, box-shadow 260ms ease; 
        }
        
        .class-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 18px 40px rgba(0,0,0,0.15); 
        }

        .tag { 
            transition: background 180ms ease, color 180ms ease, transform 180ms ease; 
        }

        .search-btn { 
            transition: transform 160ms ease, box-shadow 160ms ease; 
        }

        .form-group input:focus, .form-group select:focus { 
            box-shadow: 0 8px 20px rgba(102,126,234,0.08); 
        }

        .custom-marker {
            background-color: #667eea;
            border: 3px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .search-grid {
                grid-template-columns: 1fr;
            }

            .search-btn {
                align-self: stretch;
            }

            .results-section {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            #map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè´ Class Locator</h1>
            <p>Find and locate classes easily at UMS Campus</p>
        </div>

        <div class="search-section">
            <h2 style="margin-bottom: 20px; color: #333;">Search Classes</h2>
            
            <div class="nav-buttons">
                <a href="/" class="nav-btn">ü§ñ Kembali ke Chatbot</a>
            </div>
            
            <div class="search-grid">
                <div class="form-group">
                    <label for="courseCode">Course Code</label>
                    <input type="text" id="courseCode" placeholder="e.g., CS101">
                </div>

                <div class="form-group">
                    <label for="courseName">Course Name</label>
                    <input type="text" id="courseName" placeholder="e.g., Programming">
                </div>

                <button class="search-btn" onclick="searchClasses()">üîç Search</button>
            </div>

            <div>
                <h3 style="margin-bottom: 12px; color: #333; font-size: 0.95em;">Quick Filters:</h3>
                <div class="filter-tags">
                    <div class="tag" data-filter="time" data-value="morning" onclick="toggleFilter(this)">üïê Morning</div>
                    <div class="tag" data-filter="time" data-value="afternoon" onclick="toggleFilter(this)">üïë Afternoon</div>
                    <div class="tag" data-filter="time" data-value="evening" onclick="toggleFilter(this)">üïñ Evening</div>
                    <div class="tag" data-filter="status" data-value="available" onclick="toggleFilter(this)">‚úÖ Available</div>
                    <div class="tag" data-filter="status" data-value="open" onclick="toggleFilter(this)">‚úÖ Open</div>
                    <div class="tag" data-filter="status" data-value="upcoming" onclick="toggleFilter(this)">üîî Upcoming</div>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="map-container">
            <div class="map-header">
                <span>üìç UMS Campus Map</span>
                <span class="map-info">üÜì Powered by OpenStreetMap</span>
            </div>
            <div id="map"></div>
        </div>

        <!-- Results Section -->
        <div id="resultsContainer">
            <div class="results-section" id="classResults">
                <div class="loading-state" style="grid-column: 1/-1;">
                    <div class="loading-spinner"></div>
                    <p>Loading classes from database...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // UMS Campus coordinates
        const UMS_CENTER = [6.0367, 116.1186];
        
        let map;
        let markers = [];
        let classesData = [];
        let filteredClasses = [];
        let activeFilters = {
            time: [],
            status: []
        };

        // Building locations on UMS campus (approximate coordinates)
        const buildingLocations = {
            'Block A': [6.045982, 116.130664],
            'Block B': [6.0365, 116.1190],
            'Block C': [6.0375, 116.1175],
            'Lab 1': [6.0360, 116.1195],
            'Lab 2': [6.0380, 116.1170],
            'FKI': [6.0360, 116.1200],
            'PPIB': [6.0370, 116.1180],
            'Main Library': [6.0365, 116.1185]
        };

        // Fetch classes from API
        async function fetchClasses() {
            try {
                const response = await fetch('/api/classes');
                const data = await response.json();
                
                if (data.success && data.classes) {
                    classesData = data.classes.map(cls => {
                        // Normalize the time type
                        let timeType = (cls.timeType || '').toLowerCase();
                        
                        // If timeType is not set, determine from time
                        if (!timeType && cls.time) {
                            const hour = parseInt(cls.time.split(':')[0]);
                            if (hour < 12) timeType = 'morning';
                            else if (hour < 17) timeType = 'afternoon';
                            else timeType = 'evening';
                        }
                        
                        // Normalize status
                        let status = (cls.status || 'available').toLowerCase();
                        
                        return {
                            ...cls,
                            timeType: timeType,
                            status: status
                        };
                    });
                    
                    filteredClasses = [...classesData];
                    displayClasses(filteredClasses);
                    console.log(`‚úÖ Loaded ${classesData.length} classes from database`);
                } else {
                    showError('No classes data available');
                }
            } catch (error) {
                console.error('‚ùå Error fetching classes:', error);
                showError('Failed to load classes. Please check your connection.');
            }
        }

        // Initialize Leaflet Map
        function initMap() {
            // Create map centered on UMS
            map = L.map('map').setView(UMS_CENTER, 16);

            // Add OpenStreetMap tiles (FREE!)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Add UMS campus marker
            L.marker(UMS_CENTER).addTo(map)
                .bindPopup('<b>Universiti Malaysia Sabah</b><br>Main Campus')
                .openPopup();
        }

        function updateMapMarkers(classes) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Group classes by building
            const buildingClasses = {};
            classes.forEach(cls => {
                if (!buildingClasses[cls.building]) {
                    buildingClasses[cls.building] = [];
                }
                buildingClasses[cls.building].push(cls);
            });

            // Add markers for each building
            Object.keys(buildingClasses).forEach(building => {
                const location = buildingLocations[building];
                if (location) {
                    const classes = buildingClasses[building];
                    
                    // Create custom icon
                    const customIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="custom-marker">${classes.length}</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });

                    const marker = L.marker(location, { icon: customIcon }).addTo(map);

                    // Create popup content
                    const popupContent = `
                        <div style="max-width: 300px;">
                            <h3 style="margin: 0 0 10px 0; color: #667eea;">${building}</h3>
                            <p style="margin: 0 0 10px 0; font-weight: bold;">${classes.length} Classes:</p>
                            ${classes.map(cls => `
                                <div style="margin-bottom: 8px; padding: 8px; background: #f5f5f5; border-radius: 5px;">
                                    <strong>${cls.courseCode}</strong> - ${cls.courseName}<br>
                                    <small>Room ${cls.room} | ${cls.time}</small>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    marker.bindPopup(popupContent);
                    markers.push(marker);
                }
            });
        }

        function displayClasses(classes) {
            const resultsContainer = document.getElementById('classResults');

            if (classes.length === 0) {
                resultsContainer.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><div style="font-size: 4em; margin-bottom: 20px;">üì≠</div><h2>No Classes Found</h2><p>Try adjusting your search criteria</p></div>';
                updateMapMarkers([]);
                return;
            }

            resultsContainer.innerHTML = classes.map(cls => {
                const enrolled = cls.enrolled || 0;
                const capacity = cls.capacity || 0;
                const percentage = capacity > 0 ? Math.round((enrolled / capacity) * 100) : 0;
                
                // Normalize status for display
                let statusClass = 'status-available';
                let statusText = '‚úÖ Available';
                const status = (cls.status || '').toLowerCase();
                
                if (status === 'full' || status === 'closed') {
                    statusClass = 'status-full';
                    statusText = status === 'full' ? 'üî¥ Full' : 'üî¥ Closed';
                } else if (status === 'upcoming') {
                    statusClass = 'status-upcoming';
                    statusText = 'üîî Upcoming';
                } else if (status === 'open' || status === 'available') {
                    statusClass = 'status-available';
                    statusText = '‚úÖ ' + (status.charAt(0).toUpperCase() + status.slice(1));
                }

                return `<div class="class-card" onclick="showOnMap('${cls.building}')">
                    <h3>${cls.courseCode || 'N/A'}</h3>
                    <div><strong>${cls.courseName || 'Unnamed Course'}</strong></div>
                    <div class="class-info"><span class="info-label">Instructor:</span> ${cls.instructor || 'TBA'}</div>
                    <div class="class-info"><span class="info-label">Location:</span> ${cls.building || 'TBA'}, Room ${cls.room || 'TBA'}</div>
                    <div class="class-info"><span class="info-label">Time:</span> ${cls.time || 'TBA'}</div>
                    <div class="class-info"><span class="info-label">Days:</span> ${cls.day || 'TBA'}</div>
                    <div class="class-info"><span class="info-label">Capacity:</span> ${enrolled}/${capacity} (${percentage}%)</div>
                    <div><span class="status-badge ${statusClass}">${statusText}</span></div>
                </div>`;
            }).join('');

            // Update map markers
            updateMapMarkers(classes);
        }

        function showOnMap(building) {
            const location = buildingLocations[building];
            if (location && map) {
                map.setView(location, 18);
                
                // Find and open the popup for this building
                markers.forEach(marker => {
                    const markerLatLng = marker.getLatLng();
                    if (markerLatLng.lat === location[0] && markerLatLng.lng === location[1]) {
                        marker.openPopup();
                    }
                });

                // Scroll to map
                document.querySelector('.map-container').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function searchClasses() {
            const courseCode = document.getElementById('courseCode').value.toLowerCase();
            const courseName = document.getElementById('courseName').value.toLowerCase();

            filteredClasses = classesData.filter(cls => {
                const matchCode = !courseCode || (cls.courseCode || '').toLowerCase().includes(courseCode);
                const matchName = !courseName || (cls.courseName || '').toLowerCase().includes(courseName);
                
                // Apply active filters
                const matchTime = activeFilters.time.length === 0 || 
                    activeFilters.time.includes((cls.timeType || '').toLowerCase());
                const matchStatus = activeFilters.status.length === 0 || 
                    activeFilters.status.includes((cls.status || '').toLowerCase());
                
                return matchCode && matchName && matchTime && matchStatus;
            });

            displayClasses(filteredClasses);
        }

        function toggleFilter(element) {
            const filterType = element.dataset.filter;
            const filterValue = element.dataset.value;
            
            element.classList.toggle('active');
            
            if (element.classList.contains('active')) {
                if (!activeFilters[filterType].includes(filterValue)) {
                    activeFilters[filterType].push(filterValue);
                }
            } else {
                activeFilters[filterType] = activeFilters[filterType].filter(v => v !== filterValue);
            }
            
            searchClasses();
        }

        function showError(message) {
            const resultsContainer = document.getElementById('classResults');
            resultsContainer.innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <div style="font-size: 4em; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h2>Error Loading Classes</h2>
                    <p>${message}</p>
                </div>
            `;
        }

        // Initialize map and fetch classes on page load
        window.addEventListener('load', () => {
            initMap();
            fetchClasses();
        });
    </script>
</body>
</html>